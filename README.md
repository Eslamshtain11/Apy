# المحاسب الشخصي (Personal Accountant)

تطبيق ويب متكامل لمعلمي الدروس الخصوصية لإدارة الدخل، المصروفات، بيانات الطلاب، وأكواد الضيوف. يعتمد على **React + TailwindCSS + Vite** مع تصميم ليلي (Dark Mode) ودعم كامل للاتجاه من اليمين لليسار، ويتصل مباشرةً بـ **Supabase** كمخزن بيانات آمن متعدد المستأجرين.

## المزايا الرئيسية

- لوحة تحكم مالية تعرض المؤشرات الفعلية من Supabase دون أي بيانات وهمية.
- إدارة كشف الحساب مع بحث لحظي، تصدير، وإمكانية تعديل أو حذف الدفعات مع الحفاظ على عزل المستخدمين.
- سجل مصروفات مرتبط بالمستخدم الحالي فقط، مع حساب الإجماليات واختيار الفترات.
- إدارة الطلاب والمجموعات مع تعيين المنتسبين من قوائم متعددة وتصفية بالاسم.
- أكواد ضيوف يتم توليدها لكل مستخدم مع سياسات وصول مقيدة.
- واجهة ضيف للعرض فقط، وتدعم الجوال بالكامل.
- تصميم متجاوب مع قوائم منزلقة في الشاشات الصغيرة وحافات آمنة (safe-area) في الأجهزة الحديثة.

## الإعداد

1. أنشئ ملف `.env` في جذر المشروع وأضف مفاتيح Supabase الخاصة بك:

   ```env
   VITE_SUPABASE_URL=...
   VITE_SUPABASE_ANON_KEY=...
   ```

2. ثبت الاعتمادات وشغّل بيئة التطوير:

   ```bash
   npm install
   npm run dev
   ```

3. نفّذ مخطط قاعدة البيانات (يوجد في `supabase/schema.sql`) داخل Supabase SQL Editor لتفعيل الجداول، الأعمدة `user_id`، وسياسات Row Level Security. هذا السكربت يُسقط الجداول السابقة ويعيد إنشاءها بتريغرز تضبط `user_id` تلقائيًا لكل إدراج جديد.

   إذا كانت لديك بيانات فعلية بالفعل ولا ترغب في إسقاط الجداول، فيمكنك لصق وتشغيل الملف التصحيحي `supabase/patches/20241017_isolation_fix.sql` لضمان تفعيل العزل متعدد المستأجرين وتأكيد حسابات البريد المولّد من أرقام الهواتف. الإصدار الحالي من السكربت ينشئ الدوال في مخطط `public`، ويضيف التريغرز اللازمة، ويرفع تحذيرات (`NOTICE`) إذا وُجدت صفوف قديمة بلا `user_id` حتى يمكن معالجتها يدويًا قبل إعادة تشغيله. السكربت تصحيحي (idempotent) ويمكن تشغيله كلما احتجت لإعادة ضبط السياسات.

4. أنشئ حسابًا من خلال شاشة المصادقة داخل التطبيق. يتم إنشاء سجل المستخدم تلقائيًا في جدول `users` عند إتمام التسجيل بنجاح.

## هيكل المجلدات

```text
src/
 ├─ components/      # مكونات مشتركة (شريط جانبي، مودالات، بطاقات ...)
 ├─ contexts/        # مزوّد البيانات الرئيس المرتبط بكل مستخدم
 ├─ features/        # منطق الميزات (الدفعات، المصروفات، أكواد الضيوف، التحليلات)
 ├─ pages/           # الشاشات الرئيسية للتطبيق
 ├─ types/           # تعريفات TypeScript للكيانات
 └─ utils/           # دوال مساعدة للتنسيق والحسابات
```

## الأمان والعزل

- كل طلب نحو Supabase يُفلتر بـ `user_id = auth.uid()` ويضيف الحقل `user_id` صراحةً أثناء الإدراج لضمان العزل التام بين الحسابات.
- تم تفعيل Row Level Security مع سياسات تمنع أي مستخدم من قراءة أو تعديل بيانات غيره.
- يتم مسح الحالة المخزنة محليًا عند تغيير الجلسة أو تسجيل الخروج لتفادي تسرب البيانات بين المستخدمين.

## الاختبارات

يستخدم المشروع [Vitest](https://vitest.dev) لاختبار وظائف العزل:

```bash
npm run test
```

تتحقق الاختبارات من أن استدعاءات Supabase تضيف معاملات `user_id` وأن بيانات المستخدم الافتراضية تبقى فارغة عند فتح النماذج.

## تحويل التطبيق إلى APK

يمكن تغليف التطبيق باستخدام [Capacitor](https://capacitorjs.com/) أو دمجه داخل WebView في تطبيق React Native لتوليد ملف APK، وذلك بعد نشر الواجهة على رابط HTTPS.

## الرخصة

هذا المشروع متاح للاستخدام الداخلي والتطوير اللاحق.
